name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create .env file
        run: |
          if (Test-Path .env) {
            Write-Host ".env file already exists, using existing file"
          } else {
            Write-Host "Creating .env file from secrets..."
            $envContent = @"
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          "@
            $envContent | Out-File -FilePath .env -Encoding utf8 -NoNewline
            Write-Host ".env file created"
          }
        shell: powershell
        working-directory: ${{ github.workspace }}
        continue-on-error: true

      - name: Stop containers
        run: docker-compose down
        shell: cmd
        working-directory: ${{ github.workspace }}
        continue-on-error: true

      - name: Build and start containers
        run: |
          docker-compose build
          docker-compose up -d
        shell: cmd
        working-directory: ${{ github.workspace }}

      - name: Run database migrations
        run: docker exec juyashop-backend npx prisma migrate deploy
        shell: cmd
        continue-on-error: true

      - name: Clean up old images
        run: docker image prune -f
        shell: cmd

      - name: Verify deployment
        run: |
          Start-Sleep -Seconds 10
          $response = Invoke-WebRequest -Uri "http://localhost/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) {
            Write-Error "Health check failed"
            exit 1
          }
        shell: powershell